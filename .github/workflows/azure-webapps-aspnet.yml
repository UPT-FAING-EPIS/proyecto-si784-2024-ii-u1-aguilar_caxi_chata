
name: Deploy ASP.NET Project to Azure

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    # 1. Habilitar long paths en el registro de Windows
    - name: Enable long paths in Windows registry
      run: |
        New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" -Name "LongPathsEnabled" -Value 1 -PropertyType DWORD -Force
        Write-Output "Long paths have been enabled."
      shell: pwsh

    # 2. Checkout del repositorio con una ruta más corta
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        path: 'repo'

    # 3. Verificar la estructura del repositorio
    - name: List files in the repository
      run: ls -R ./repo

    # 4. Compilación del proyecto con MSBuild
    - name: Build the project with MSBuild
      run: msbuild ./repo/Proyecto_RUMI/Proyecto_Web2_Aguilar_Chino_Gonzales_Perez.sln /p:Configuration=Release

    # 5. Publicación del proyecto usando MSBuild
    - name: Publish using MSBuild
      run: msbuild ./repo/Proyecto_RUMI/Proyecto_Web2_Aguilar_Chino_Gonzales_Perez.sln /p:Configuration=Release /p:DeployOnBuild=true /p:PublishProfile=Properties/PublishProfiles/CalidadRumi-WebDeploy.pubxml /p:WebPublishMethod=Package /p:PackageLocation="$(System.DefaultWorkingDirectory)/publish_output"

    # 6. Cargar el artefacto generado para el despliegue
    - name: Upload artifact for deployment job
      uses: actions/upload-artifact@v3
      with:
        name: aspnet-app
        path: $(System.DefaultWorkingDirectory)/publish_output/**/*.zip

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
    # 7. Descargar el artefacto generado en el paso anterior
    - name: Download artifact
      uses: actions/download-artifact@v3
      with:
        name: aspnet-app

    # 8. Desplegar a Azure Web App usando el perfil de publicación
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ secrets.AZURE_WEBAPP_NAME }}              # Nombre de la aplicación en Azure
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}  # Perfil de publicación en secreto de GitHub
        package: aspnet-app/*.zip                                # Paquete de publicación

