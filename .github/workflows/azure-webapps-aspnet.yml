
name: Deploy ASP.NET Project to Azure

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    # 1. Habilitar rutas largas en Git
    - name: Enable long paths in Git
      run: git config --system core.longpaths true

    # 2. Checkout del repositorio
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        path: './repo'

    # **Agregar el paso de configuración de MSBuild**
    # Este paso instala MSBuild y lo configura en el PATH para que esté disponible en las siguientes etapas
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1

    # 3. Restaurar paquetes NuGet
    - name: Restore NuGet packages
      run: nuget restore ./repo/Proyecto_RUMI/Proyecto_Web2_Aguilar_Chino_Gonzales_Perez.sln

    # 4. Compilar el proyecto con MSBuild
    # Asegúrate de que MSBuild esté configurado y disponible en el PATH para este paso
    - name: Build with MSBuild
      run: msbuild ./repo/Proyecto_RUMI/Proyecto_Web2_Aguilar_Chino_Gonzales_Perez.sln /p:Configuration=Release

    # 5. Publicar usando MSBuild con el perfil de publicación
    - name: Publish using MSBuild
      run: msbuild ./repo/Proyecto_RUMI/Proyecto_Web2_Aguilar_Chino_Gonzales_Perez.sln /p:Configuration=Release /p:DeployOnBuild=true /p:PublishProfile=Properties/PublishProfiles/CalidadRumi-WebDeploy.pubxml /p:WebPublishMethod=MSDeploy /p:UserName="$(UserName)" /p:Password="$(UserPWD)" /verbosity:detailed
      env:
        UserName: ${{ secrets.AZURE_WEBAPP_USER }}        # Secreto con nombre de usuario
        UserPWD: ${{ secrets.AZURE_WEBAPP_PASSWORD }}     # Secreto con contraseña del App Service

    # 6. Desplegar a Azure Web App usando publish-profile (opcional)
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ secrets.AZURE_WEBAPP_NAME }}          # Nombre de la aplicación en Azure
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}  # Perfil de publicación en secreto de GitHub
        package: ./repo/publish_output/**/*.zip

